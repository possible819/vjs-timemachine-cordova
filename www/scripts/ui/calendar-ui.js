class CalendarUI{constructor(){this.calendarContainer=document.getElementById("calendar-container"),this.calendar=document.getElementById("calendar"),this.prevCalendar=document.getElementById("prev-calendar"),this.nextCalendar=document.getElementById("next-calendar"),this.addEventListeners()}addEventListeners(){this.calendarContainer.addEventListener("touchend",this.adjustAnimation.bind(this))}clearCalendars(){this.clearDateRows(this.prevCalendar),this.clearDateRows(this.calendar),this.clearDateRows(this.nextCalendar)}renderCalendars(){this.clearCalendars(),this.renderCurrentCalendar(),this.renderPrevCalendar(),this.renderNextCalendar(),this.adjustXScroll()}adjustXScroll(){this.calendarContainer.scrollLeft=window.screen.availWidth}renderCurrentCalendar(){this.clearDateRows(this.calendar),this.renderDateRows(window.stdDateUtil.getDateRange(),this.calendar,window.stdDateUtil.date);const e=window.stdDateUtil.getYearStr(),t=window.stdDateUtil.getMonthStr();this.calendar.getYearMonth=function(){return`${e}${t}`}}renderPrevCalendar(){const e=new DateUtil(window.stdDateUtil.date);e.date.setMonth(e.date.getMonth()-1),this.prevDateUtil=e,this.clearDateRows(this.prevCalendar),this.renderDateRows(this.prevDateUtil.getDateRange(),this.prevCalendar);const t=this.prevDateUtil.getYearStr(),a=this.prevDateUtil.getMonthStr();this.prevCalendar.getYearMonth=function(){return`${t}${a}`}}renderNextCalendar(){const e=new DateUtil(window.stdDateUtil.date);e.date.setMonth(e.date.getMonth()+1),this.nextDateUtil=e,this.clearDateRows(this.nextCalendar),this.renderDateRows(this.nextDateUtil.getDateRange(),this.nextCalendar);const t=this.nextDateUtil.getYearStr(),a=this.nextDateUtil.getMonthStr();this.nextCalendar.getYearMonth=function(){return`${t}${a}`}}adjustAnimation(){if(this.calendarContainer.scrollLeft===window.screen.availWidth||this.calendarContainer.scrollLeft===this.calendarContainer.clientWidth)return;const e=window.screen.availWidth,t=e/3;e-t>=this.calendarContainer.scrollLeft?(this.adjustPrevCalendarAnimation(),setTimeout(()=>{},500)):e+t<=this.calendarContainer.scrollLeft?(this.adjustNextCalendarAnimation(),setTimeout(()=>{},500)):this.adjustSnapBackCalendarAnimation()}showSpinner(e){window.spinner.show({message:e})}hideSpinner(){window.spinner.hide()}adjustPrevCalendarAnimation(){window.scroller.scrollAnimate(this.calendarContainer,{axis:"x",to:0,duration:15,callback:()=>{this.switchPrevCurrent()}})}adjustNextCalendarAnimation(){window.scroller.scrollAnimate(this.calendarContainer,{axis:"x",to:2*this.calendarContainer.offsetWidth,duration:15,callback:()=>{this.switchNextCurrent()}})}adjustSnapBackCalendarAnimation(){window.scroller.scrollAnimate(this.calendarContainer,{axis:"x",to:this.calendarContainer.offsetWidth,duration:15})}switchPrevCurrent(){this.nextCalendar.remove(),this.calendar.setAttribute("id","next-calendar"),this.nextCalendar=this.calendar,this.prevCalendar.setAttribute("id","calendar"),this.calendar=this.prevCalendar,this.nextDateUtil=window.stdDateUtil,window.stdDateUtil=this.prevDateUtil,this.prevCalendar=document.createElement("div"),this.prevCalendar.setAttribute("id","prev-calendar"),this.calendarContainer.insertBefore(this.prevCalendar,this.calendarContainer.firstElementChild),this.calendarContainer.scrollLeft=window.screen.availWidth,this.renderPrevCalendar(),this.fireCalendarChangeEvent()}switchNextCurrent(){this.prevCalendar.remove(),this.calendar.setAttribute("id","prev-calendar"),this.prevCalendar=this.calendar,this.nextCalendar.setAttribute("id","calendar"),this.calendar=this.nextCalendar,this.prevDateUtil=window.stdDateUtil,window.stdDateUtil=this.nextDateUtil,this.nextCalendar=document.createElement("div"),this.nextCalendar.setAttribute("id","next-calendar"),this.calendarContainer.appendChild(this.nextCalendar),this.calendarContainer.scrollLeft=window.screen.availWidth,this.renderNextCalendar(window.stdDateUtil),this.fireCalendarChangeEvent()}fireCalendarChangeEvent(){document.dispatchEvent(new CustomEvent("date-switched"))}markByDate(){this.isSameYearMonth(this.calendar.getYearMonth())&&this.getDateCellByDate(window.currentDateUtil.getDate()).select()}markAssigneByDates(e){this.disassignCell(),e&&e.length&&e.forEach(e=>{const t=this.getDateCellByDate(e);t.setAttribute("assigned",""),t.hasAttribute("selected")&&this.fireReadDiaryEvent()})}markTodayCircle(){const e=new DateUtil,t=`${e.getYearStr()}${e.getMonthStr()}`,a=this.prevCalendar.getYearMonth(),n=this.calendar.getYearMonth(),r=this.nextCalendar.getYearMonth();let i;t===a?i=this.getDateCellByDateFromCalendar(e.getDate(),this.prevCalendar):t===n?i=this.getDateCellByDateFromCalendar(e.getDate(),this.calendar):t===r&&(i=this.getDateCellByDateFromCalendar(e.getDate(),this.nextCalendar)),i&&(this.todayCell&&this.todayCell.classList.remove("today"),this.todayCell=i,this.todayCell.classList.add("today"))}fireReadDiaryEvent(){const e=window.currentDateUtil.getDateFileNameFormat()+".txt";document.dispatchEvent(new CustomEvent("show-content-viewer",{detail:{fileName:e}}))}disselectCells(){Array.from(this.calendarContainer.querySelectorAll("div.date-cell[selected]")).forEach(e=>{e.disselect()})}disassignCell(){Array.from(this.calendar.querySelectorAll("div.date-cell[assigned]")).forEach(e=>{e.removeAttribute("assigned")})}getDateCellByDate(e){return this.getDateCellByDateFromCalendar(e,this.calendar)}getDateCellByDateFromCalendar(e,t){let a=t.querySelector(`span[date="${e}"]`).parentElement;for(;!a.classList.contains("date-cell");)a=a.parentElement;return a}clearDateRows(e){Array.from(e.querySelectorAll("div.dates-row")).forEach(e=>{e.remove()})}renderDateRows(e,t,a){let n=this.getDateRow();for(e.forEach(e=>{let r=this.getDateCell(),i=this.getDate(e);if(r.appendChild(i),n.appendChild(r),a&&e){const t=`${a.getFullYear()}-${a.getMonth()+1}-${e}`,n=new Date;t===`${n.getFullYear()}-${n.getMonth()+1}-${n.getDate()}`&&r.classList.add("today")}7===n.children.length&&(t.appendChild(n),n=this.getDateRow())}),n.hasChildNodes()&&t.appendChild(n);t.children.length<6;)t.appendChild(this.getEmptyDatesRow())}getEmptyDatesRow(){const e=document.createElement("div");return e.classList.add("dates-row"),e}getDateRow(){let e=document.createElement("div");return e.classList.add("dates-row"),e}getDateCell(){let e=document.createElement("div");return e.classList.add("date-cell"),e.addEventListener("click",()=>{e.innerText&&e.innerText.length>0&&e.select()}),e.select=(()=>{this.disselectCells(),e.marking(),this.changeDateValue(e.getDate()),e.hasAttribute("assigned")?this.fireReadDiaryEvent():document.dispatchEvent(new CustomEvent("show-empty-viewer"))}),e.marking=function(){const t=CalendarUI.getSelectedMark();e.appendChild(t),e.selectedMark=t,e.setAttribute("selected","")},e.disselect=(()=>{e.removeAttribute("selected"),e.removeChild(e.selectedMark)}),e.getDate=(()=>e.querySelector("span[date]").getAttribute("date")),e}getDate(e){let t=document.createElement("span");return t.innerText=e,t.classList.add("date"),t.setAttribute("date",e),t}changeDateValue(e){window.currentDateUtil=window.stdDateUtil,window.currentDateUtil.setDate(e)}isSameYearMonth(e){return e===`${window.currentDateUtil.getYearStr()}${window.currentDateUtil.getMonthStr()}`}static getSelectedMark(){const e=document.createElement("object");return e.setAttribute("type","image/svg+xml"),e.setAttribute("data","./assets/images/selected-mark.svg"),e.addEventListener("load",function(){const e=JSON.parse(localStorage.getItem("tm.setting.theme")),t=window.CONST.THEMES.filter(t=>t.name===e)[0];this.contentDocument.getElementById("selected-mark").style.fill=t.colors["--main-theme-color"]}),e}}