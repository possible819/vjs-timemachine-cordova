class AuthUI{constructor(){this.pwdDisplayText=document.getElementById("auth-display-text"),this.lockerSvgObject=document.getElementById("auth-locker-img"),this.pwdUnits=Array.from(document.querySelectorAll("div.auth-unit")),this.changableButton=document.querySelector("button#changable-btn"),this.numPadButtons=Array.from(document.querySelectorAll("button.auth-num-pad")),this.registerEventListeners()}registerEventListeners(){this.numPadButtons.forEach(t=>{t.onclick=this.numPadClicked.bind(this)}),document.addEventListener("show-pwd-change",t=>{this.loadLockerSvg(),this.readySetupNewPwd(),this.successCallback=t.detail.successCallback,this.cancelCallback=t.detail.cancelCallback}),document.addEventListener("show-pwd-check",t=>{this.loadLockerSvg(),this.readyCheckAuth(),this.successCallback=t.detail.successCallback}),document.addEventListener("auth-checked",t=>{t.detail?this.successCallback():(navigator.vibrate(500),this.showMissMatchText(),this.clearFilledUnit(),this.pwd="")})}loadLockerSvg(){this.lockerSvgObject.setAttribute("data","./assets/images/locker.svg"),this.lockerSvgObject.addEventListener("load",function(){const t=JSON.parse(localStorage.getItem(CONST.LS_KEYS.THEME)),e=window.CONST.THEMES.filter(e=>e.name===t)[0];this.contentDocument.querySelectorAll(".locker-svg").forEach(t=>{t.style.fill=e.colors["--main-theme-color"]})})}readySetupNewPwd(){this.clearFilledUnit(),this.showSetupText(),this.showCancelBtn(),this.isSetupNewPwd=!0,this.isCheckAuth=!1,this.isConfirmPwd=!1,this.pwd="",location.hash="auth"}readySetupConfirmPwd(){this.clearFilledUnit(),this.showConfirmText(),this.isConfirmPwd=!0,this.confirmPwd=""}readyCheckAuth(){this.clearFilledUnit(),this.showCheckAuthText(),this.checkTouchIdUsable()?this.showTouchIdBtn():this.hideCancelBtn(),this.isSetupNewPwd=!1,this.isCheckAuth=!0,this.pwd="",location.hash="auth",this.checkTouchIdUsable()?this.showTouchIdAuth():this.hideTouchIdAuth()}checkTouchIdUsable(){return JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.TOUCH_ID_ACTIVE))}showCancelBtn(){this.changableButton.classList.remove("touch-id"),this.changableButton.classList.remove("disabled"),this.changableButton.innerText="취소",this.changableButton.setAttribute("value","cancel")}hideCancelBtn(){this.changableButton.classList.remove("touch-id"),this.changableButton.classList.add("disabled"),this.changableButton.innerText=""}showTouchIdBtn(){this.changableButton.innerText="",this.changableButton.classList.remove("disabled"),this.changableButton.classList.contains("touch-id")||this.changableButton.classList.add("touch-id");const t=document.createElement("object");t.setAttribute("type","image/svg+xml"),t.setAttribute("data","./assets/images/finger-print.svg"),t.addEventListener("load",function(){const t=JSON.parse(localStorage.getItem("tm.setting.theme")),e=window.CONST.THEMES.filter(e=>e.name===t)[0];this.contentDocument.querySelectorAll(".finger-print-svg").forEach(t=>{t.style.fill=e.colors["--main-theme-color"]})}),this.changableButton.appendChild(t),this.changableButton.fingerPrintIcon=t,this.changableButton.setAttribute("value","touch-id")}hideTouchIdAuth(){this.changableButton.classList.add("disabled")}clearFilledUnit(){this.pwdUnits.forEach(t=>{t.removeAttribute("filled")})}numPadClicked(t){const e=t.currentTarget.value;switch(e){case"touch-id":this.showTouchIdAuth();break;case"cancel":this.routeBack();break;case"del":this.delClicked();break;default:this.pwdClicked(e)}}showTouchIdAuth(){window.touchid?window.touchid.checkSupport(()=>{this.checkTouchIdUsable()?window.touchid.authenticate(()=>{document.dispatchEvent(new CustomEvent("auth-checked",{detail:!0}))},null,"잠금 해제"):this.notSetTouchId()},this.unavailTouchId):this.unavailTouchId()}notSetTouchId(){window.ha.openConfirm({title:"Touch ID 사용 불가",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"Touch ID가 설정되어 있지 않습니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]})}unavailTouchId(){window.ha.openConfirm({title:"Touch ID 사용 불가",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"Touch ID를 사용 할 수 없습니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]})}pwdClicked(t){event.currentTarget.classList.contains("disabled")||(this.isSetupNewPwd?this.isConfirmPwd?this.confirmPwd.length<4&&(this.confirmPwd+=t,this.pwdUnits[this.confirmPwd.length-1].setAttribute("filled",""),4===this.confirmPwd.length&&this.pwd===this.confirmPwd?(document.dispatchEvent(new CustomEvent("pwd-inited",{detail:this.pwd})),this.successCallback()):4===this.confirmPwd.length&&this.pwd!==this.confirmPwd&&(this.showMissMatchText(),this.clearFilledUnit(),this.confirmPwd="",navigator.vibrate(500))):(this.pwd+=t,this.pwdUnits[this.pwd.length-1].setAttribute("filled",""),4===this.pwd.length&&this.readySetupConfirmPwd()):this.isCheckAuth&&this.pwd.length<4&&(this.pwd+=t,this.pwdUnits[this.pwd.length-1].setAttribute("filled",""),4===this.pwd.length&&document.dispatchEvent(new CustomEvent("check-auth",{detail:this.pwd}))))}delClicked(){this.isSetupNewPwd?!this.isConfirmPwd&&this.pwd.length>0?this.pwd=this.pwd.slice(0,-1):this.isConfirmPwd&&this.confirmPwd.length>0?this.confirmPwd=this.confirmPwd.slice(0,-1):navigator.vibrate(500):this.isCheckAuth&&(this.pwd.length>0?this.pwd=this.pwd.slice(0,-1):navigator.vibrate(500));for(let t=3;t>=0;t--)if(this.pwdUnits[t].hasAttribute("filled")){this.pwdUnits[t].removeAttribute("filled");break}}routeBack(){history.back(),setTimeout(()=>{document.getElementById("pwd-active-checkbox").checked=JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.PWD_ACTIVE))},100)}showSetupText(){this.showDisplayText("새로운 암호를 입력하세요.")}showConfirmText(){this.showDisplayText("새로운 암호를 재입력하세요.")}showCheckAuthText(){this.showDisplayText("암호를 입력하세요.")}showMissMatchText(){this.showDisplayText("올바른 암호를 입력하세요.")}showDisplayText(t){this.pwdDisplayText.innerText=t}}