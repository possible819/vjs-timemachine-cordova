class SettingUI{constructor(){this.settingView=document.getElementById("setting"),this.settingViews=document.getElementById("setting-views"),this.settingVersion=document.getElementById("setting-version"),this.appVersion=document.getElementById("app-version"),this.passwordActive=document.getElementById("pwd-active"),this.passwordActiveText=document.getElementById("pwd-active-text"),this.initialViewSetting=document.getElementById("initial-view-setting"),this.currentThemeText=document.getElementById("current-theme-text"),this.themeSetting=document.getElementById("theme-setting"),this.alarmActive=document.getElementById("alarm-active"),this.alarmTime=document.getElementById("alarm-time"),this.resetBtn=document.getElementById("reset"),this.importBtn=document.getElementById("import"),this.exportBtn=document.getElementById("export"),this.setInitValues(),this.registerEventListeners()}setInitValues(){this.initPasswordActive(),this.initCurrentTheme(),this.initInitialView(),this.initAlaramActive(),this.initAlaramTime()}initPasswordActive(){const t=this.getLS(window.CONST.LS_KEYS.PWD_ACTIVE);"boolean"==typeof t?this.passwordActiveText.innerText=t?"켜짐":"꺼짐":(this.setLS(window.CONST.LS_KEYS.PWD_ACTIVE,!1),this.passwordActiveText.innerText="꺼짐")}initCurrentTheme(){const t=this.getLS(window.CONST.LS_KEYS.THEME)?this.getLS(window.CONST.LS_KEYS.THEME):this.setLS(window.CONST.LS_KEYS.THEME,window.CONST.THEMES[0].name),e=window.CONST.THEMES.filter(e=>e.name===t)[0];this.currentThemeText.innerText=e?e.description:"기본"}initInitialView(){const t=this.initialViewSetting.querySelector("span#initial-view");let e=this.getLS(window.CONST.LS_KEYS.INITIAL_VIEW)?this.getLS(window.CONST.LS_KEYS.INITIAL_VIEW):this.setLS(window.CONST.LS_KEYS.INITIAL_VIEW,{name:"캘린더",route:"calendar"});t.innerText=e.name}initAlaramActive(){this.alarmActive.checked=this.getLS(window.CONST.LS_KEYS.ALARM_ACTIVE)?this.getLS(window.CONST.LS_KEYS.ALARM_ACTIVE):this.setLS(window.CONST.LS_KEYS.ALARM_ACTIVE,!1),this.alarmActive.checked&&this.alarmTime.removeAttribute("disabled")}initAlaramTime(){this.alarmTime.value=this.getLS(window.CONST.LS_KEYS.ALARM_TIME)?this.getLS(window.CONST.LS_KEYS.ALARM_TIME):this.setLS(window.CONST.LS_KEYS.ALARM_TIME,"00:00")}registerEventListeners(){this.passwordActive.onclick=this.checkAuthBeforeSetting.bind(this),this.initialViewSetting.onclick=this.showInitialViewSetting.bind(this),this.themeSetting.onclick=this.showThemeSetting.bind(this),this.alarmActive.onchange=this.alarmActiveChanged.bind(this),this.alarmTime.onchange=this.alarmTimeInputHandler.bind(this),this.resetBtn.onclick=this.resetDiary.bind(this),this.importBtn.onclick=this.importDiary.bind(this),this.exportBtn.onclick=this.exportDiary.bind(this)}initAppVersion(t){this.settingVersion.innerText=t,this.appVersion.innerText=t}checkAuthBeforeSetting(){this.getLS(window.CONST.LS_KEYS.PWD_ACTIVE)?document.dispatchEvent(new CustomEvent("show-pwd-check",{detail:{successCallback:this.showPasswordSetting.bind(this)}})):this.showPasswordSetting()}showPasswordSetting(){location.hash="setting",setTimeout(()=>{this.settingViews.insertBefore(this.getPwdSettingViewList(),this.settingViews.firstElementChild.nextElementSibling),this.settingViews.style.overflowX="auto",window.scroller.scrollAnimate(this.settingViews,{axis:"x",to:this.settingViews.clientWidth,duration:15}),setTimeout(()=>{this.settingViews.style.overflowX="hidden"})},200)}showInitialViewSetting(){this.settingViews.insertBefore(this.getInitialViewList(),this.settingViews.firstElementChild.nextElementSibling),this.settingViews.style.overflowX="auto",window.scroller.scrollAnimate(this.settingViews,{axis:"x",to:this.settingViews.clientWidth,duration:15}),setTimeout(()=>{this.settingViews.style.overflowX="hidden"},300)}showThemeSetting(){this.settingViews.insertBefore(this.getThemeSettingList(),this.settingViews.firstElementChild.nextElementSibling),this.settingViews.style.overflowX="auto",window.scroller.scrollAnimate(this.settingViews,{axis:"x",to:this.settingViews.clientWidth,duration:15}),setTimeout(()=>{this.settingViews.style.overflowX="hidden"},300)}getPwdSettingViewList(){if(!this.pwdSettingViewList){this.pwdSettingViewList=document.createElement("div"),this.pwdSettingViewList.setAttribute("id","pwd-setting-view-list"),this.pwdSettingViewList.classList.add("setting-view"),this.pwdActiveOption=document.createElement("div"),this.pwdActiveOption.classList.add("option-item"),this.pwdActiveOptionText=document.createElement("span"),this.pwdActiveOptionText.classList.add("title"),this.pwdActiveOptionText.innerText="암호 잠금",this.pwdActiveCheck=document.createElement("input"),this.pwdActiveCheck.setAttribute("type","checkbox"),this.pwdActiveCheck.setAttribute("id","pwd-active-checkbox"),this.pwdActiveCheck.checked=this.getLS(window.CONST.LS_KEYS.PWD_ACTIVE),this.pwdActiveOption.appendChild(this.pwdActiveOptionText),this.pwdActiveOption.appendChild(this.pwdActiveCheck),this.touchIdSupported().then(()=>{this.fingerPrintOption=document.createElement("div"),this.fingerPrintOption.classList.add("option-item"),this.fingerPrintText=document.createElement("span"),this.fingerPrintText.classList.add("title"),this.fingerPrintText.innerText="Touch ID",this.fingerPrintCheck=document.createElement("input"),this.fingerPrintCheck.setAttribute("type","checkbox"),this.fingerPrintCheck.checked=this.getLS(window.CONST.LS_KEYS.TOUCH_ID_ACTIVE),this.fingerPrintOption.appendChild(this.fingerPrintText),this.fingerPrintOption.appendChild(this.fingerPrintCheck),this.pwdSettingViewList.insertBefore(this.fingerPrintOption,this.pwdSettingViewList.querySelector("div.empty-item")),this.pwdActiveCheck.checked||this.fingerPrintCheck.setAttribute("disabled",""),this.fingerPrintCheck.onchange=(t=>{let e=t.currentTarget.checked;setTimeout(()=>{e&&window.touchid?this.touchIdSupported().catch(()=>{window.ha.openConfirm({title:"Touch ID 등록 실패",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,text:"Touch ID를 사용 할 수 없습니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]})}).finally(()=>{this.setLS(window.CONST.LS_KEYS.TOUCH_ID_ACTIVE,e)}):this.setLS(window.CONST.LS_KEYS.TOUCH_ID_ACTIVE,e)},300)})});const t=document.createElement("div");t.classList.add("empty-item"),this.pwdResetOption=document.createElement("div"),this.pwdResetOption.classList.add("option-item","activable"),this.pwdResetText=document.createElement("span"),this.pwdResetText.classList.add("title"),this.pwdResetText.innerText="암호 변경",this.pwdResetOption.appendChild(this.pwdResetText),this.pwdResetOption.onclick=(t=>{t.currentTarget.hasAttribute("disabled")||document.dispatchEvent(new CustomEvent("show-pwd-change",{detail:{successCallback:()=>{history.back()},cancelCallback:()=>{history.back()}}}))}),this.pwdSettingViewList.appendChild(this.pwdActiveOption),this.pwdSettingViewList.appendChild(t),this.pwdSettingViewList.appendChild(this.pwdResetOption),this.pwdActiveCheck.checked||this.pwdResetOption.setAttribute("disabled",""),this.pwdActiveCheck.onchange=(t=>{t.currentTarget.checked?setTimeout(()=>{document.dispatchEvent(new CustomEvent("show-pwd-change",{detail:{successCallback:()=>{history.back(),this.activePwd()},cancelCallback:()=>{this.deactivePwd()}}}))},500):this.deactivePwd()})}return this.pwdSettingViewList}activePwd(){this.fingerPrintCheck&&this.fingerPrintCheck.removeAttribute("disabled"),this.pwdResetOption.removeAttribute("disabled"),this.passwordActiveText.innerText="켜짐",this.setLS(window.CONST.LS_KEYS.PWD_ACTIVE,!0)}deactivePwd(){this.pwdActiveCheck.checked=!1,this.fingerPrintCheck&&(this.fingerPrintCheck.checked=!1,this.fingerPrintCheck.setAttribute("disabled","")),this.pwdResetOption.setAttribute("disabled",""),this.passwordActiveText.innerText="꺼짐",this.setLS(window.CONST.LS_KEYS.PWD_ACTIVE,!1),this.setLS(window.CONST.LS_KEYS.TOUCH_ID_ACTIVE,!1),document.dispatchEvent(new CustomEvent("pwd-deactived"))}cancelPwdInit(){history.back(),setTimeout(()=>{this.deactivePwd()},200)}getInitialViewList(){if(!this.initialViewList){this.initialViewList=document.createElement("div"),this.initialViewList.setAttribute("id","initial-view-list"),this.initialViewList.classList.add("setting-view");let t=this.getLS(window.CONST.LS_KEYS.INITIAL_VIEW)?this.getLS(window.CONST.LS_KEYS.INITIAL_VIEW):{name:"캘린더",route:"calendar"};window.CONST.INITIAL_VIEWS.forEach(e=>{const i=document.createElement("div");i.setAttribute("route",e.route),i.classList.add("option-item","activable","option"),i.select=function(){if(this.getAttribute("selected"))return;const t=SettingUI.getCheckIcon();this.appendChild(t),this.checkElement=t,this.setAttribute("selected","")},i.disselect=function(){this.removeChild(this.checkElement),this.removeAttribute("selected")};const s=document.createElement("span");s.classList.add("title"),s.innerText=e.name,i.appendChild(s),i.getInfoObj=(()=>({name:e.name,route:e.route})),t.route===e.route&&i.select(),i.onclick=(t=>{this.initialViewList.querySelector("div.option[selected]").disselect(),t.currentTarget.select(),this.setLS(window.CONST.LS_KEYS.INITIAL_VIEW,t.currentTarget.getInfoObj()),this.initInitialView()}),this.initialViewList.appendChild(i)})}return this.initialViewList}getThemeSettingList(){if(!this.themeList){this.themeList=document.createElement("div"),this.themeList.setAttribute("id","theme-list"),this.themeList.classList.add("setting-view");let t=this.getLS(window.CONST.LS_KEYS.THEME)?this.getLS(window.CONST.LS_KEYS.THEME):{name:"basic",description:"기본"};window.CONST.THEMES.forEach(e=>{const i=document.createElement("div");i.setAttribute("theme",e.name),i.classList.add("option-item","activable","option"),i.select=function(){if(this.getAttribute("selected"))return;const t=SettingUI.getCheckIcon();this.appendChild(t),this.checkElement=t,this.setAttribute("selected","")},i.disselect=function(){this.removeChild(this.checkElement),this.removeAttribute("selected")};const s=document.createElement("span");s.classList.add("title"),s.innerText=e.description,i.appendChild(s),i.getInfoObj=(()=>e),t===e.name&&i.select(),i.onclick=(t=>{this.themeList.querySelector("div.option[selected]").disselect(),t.currentTarget.select(),this.setLS(window.CONST.LS_KEYS.THEME,t.currentTarget.getInfoObj().name),this.initCurrentTheme(),document.dispatchEvent(new CustomEvent("theme-changed"))}),this.themeList.appendChild(i)})}return this.themeList}alarmActiveChanged(){const t=this.alarmActive.checked;t?(this.alarmTime.removeAttribute("disabled"),this.fireAddAlarmEvent()):(this.alarmTime.setAttribute("disabled",""),this.fireClearAlarmEvent()),this.setLS(window.CONST.LS_KEYS.ALARM_ACTIVE,t)}alarmTimeInputHandler(t){let e=t.currentTarget.value;e||(e="00:00",setTimeout(()=>{this.alarmTime.value=e,this.alarmTime.blur()},100)),this.fireAddAlarmEvent(),this.setLS(window.CONST.LS_KEYS.ALARM_TIME,e)}fireAddAlarmEvent(){const t=this.alarmTime.value.split(":"),e=parseInt(t[0]),i=parseInt(t[1]);if(isNaN(e)||isNaN(i))return this.alarmActive.checked=!1,void this.alarmActiveChanged();document.dispatchEvent(new CustomEvent("alarm-enabled",{detail:{hour:e,minute:i}}))}fireClearAlarmEvent(){document.dispatchEvent(new CustomEvent("alarm-disabled"))}resetDiary(){window.ha.openConfirm({title:"초기화",message:"작성한 모든 일기가 삭제 됩니다.",type:CONST.NATIVE_STYLE.ALERT.ACTION,options:[{name:"초기화",type:CONST.NATIVE_STYLE.BTN.DESTRUCTIVE,callback:()=>{document.dispatchEvent(new CustomEvent("reset-diary"))}},{name:"취소",type:CONST.NATIVE_STYLE.BTN.CANCEL}]})}importDiary(){window.ha.openConfirm({title:"불러오기",message:"기기에 저장되어 있는 일기를 불러 옵니다.",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT,callback:()=>{document.dispatchEvent(new CustomEvent("import-diary"))}},{name:"취소",type:CONST.NATIVE_STYLE.BTN.CANCEL}]})}exportDiary(){window.ha.openConfirm({title:"내보내기",message:"작성한 일기를 기기에 저장 합니다.",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT,callback:()=>{document.dispatchEvent(new CustomEvent("export-diary"))}},{name:"취소",type:CONST.NATIVE_STYLE.BTN.CANCEL}]})}routeBack(){this.settingViews.scrollLeft>0?window.scroller.scrollAnimate(this.settingViews,{axis:"x",to:0,duration:15}):location.hash=JSON.parse(localStorage.getItem(CONST.LS_KEYS.INITIAL_VIEW)).route}getLS(t){return JSON.parse(window.localStorage.getItem(t))}setLS(t,e){return window.localStorage.setItem(t,JSON.stringify(e)),e}static getCheckIcon(){const t=document.createElement("object");return t.setAttribute("type","image/svg+xml"),t.setAttribute("data","./assets/images/check-icon.svg"),t.addEventListener("load",function(){const t=JSON.parse(localStorage.getItem("tm.setting.theme")),e=window.CONST.THEMES.filter(e=>e.name===t)[0];this.contentDocument.getElementById("check-icon").style.fill=e.colors["--main-theme-color"]}),t}touchIdSupported(){return new Promise((t,e)=>{"touchid"in window?window.touchid.checkSupport(()=>{t(!0)},()=>{e({title:"Touch ID 사용 불가",message:"Touch ID를 사용 할 수 없습니다.",options:[{name:"확인"}]})}):e({title:"Touch ID 사용 불가",message:"Touch ID를 사용 할 수 없습니다.",options:[{name:"확인"}]})})}}