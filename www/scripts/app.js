window.stdDateUtil=new DateUtil,window.currentDateUtil=new DateUtil,window.ha=new HybridAlert,window.spinner=new HybridSpinner,window.execLogger=new ExecLogger;const viewerUI=new ViewerUI,headerUI=new HeaderUI,calendarUI=new CalendarUI,listUI=new ListUI,searchUI=new SearchUI,blocker=new BlockerUI,editorUI=new EditorUI,sideBarUI=new SideBarUI,settingUI=new SettingUI,webDBUtil=new WebDBUtil,pageUtil=new PageUtil,fileTransUtil=new FileTransferUtil,localNotificationUtil=new LocalNotificationUtil;new AuthUI;const app={initializeApplication:function(){"use strict";app.adjustTheme(),app.adjustFastClick(),app.registEventListeners(),webDBUtil.initialize(),headerUI.showCommonHeader(),viewerUI.renderViewer(),calendarUI.renderCalendars(),listUI.renderLists(),settingUI.initAppVersion(window.CONST.APP.VERSION),pageUtil.initialSetup(app.getEntryPoint(),Array.from(document.querySelectorAll("div[page]"))),app.changeHiddenPickerValue(),app.hideSplashScreen(),fileTransUtil.storageInitialize(),document.getElementById("starting-page").remove()},adjustTheme:function(){"use strict";let e=JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.THEME));e=e||"basic";const t=window.CONST.THEMES.filter(t=>t.name===e)[0];for(let e in t.colors)t.colors[e]&&document.body.style.setProperty(e,t.colors[e]);document.dispatchEvent(new CustomEvent("theme-adjusted")),app.adjustStatusBarColor()},adjustStatusBarColor:function(e){"use strict";location.protocol.indexOf("http")<0&&(window.StatusBar.overlaysWebView(!1),e||(e=document.body.style.getPropertyValue("--main-theme-color")),window.StatusBar.backgroundColorByHexString(e))},adjustFastClick:function(){"use strict";window.FastClick.attach(document.body),window.FastClick.attach(document.body)},registEventListeners:function(){"use strict";document.addEventListener("app-actived",app.activedHandler),document.addEventListener("app-deactived",app.deactivedHandler),document.addEventListener("app-enter-background",app.enterBackgroundHandler),window.addEventListener("statusTap",app.scrollToTop),document.addEventListener("web-db-initialized",app.getMonthDiaryList),document.addEventListener("route-back",app.routeBack),document.addEventListener("menu-btn-click",app.menuBtnClick),document.addEventListener("show-empty-viewer",app.showEmptyViewer),document.addEventListener("show-content-viewer",app.showContentViewer),document.addEventListener("show-empty-editor",app.showEmptyEditor),document.addEventListener("show-content-editor",app.showContentEditor),document.addEventListener("show-list-preview",app.showListPreview),document.addEventListener("save-diary",app.saveDiary),document.addEventListener("diary-saved",()=>{document.dispatchEvent(new CustomEvent("show-content-viewer",{detail:{fileName:window.currentDateUtil.getDateFileNameFormat()+".txt"}}))}),document.addEventListener("delete-diary",app.deleteDiary),document.addEventListener("date-switched",app.dateSwitched),document.addEventListener("date-picked",()=>{app.refreshDiary()}),document.addEventListener("pwd-inited",app.savePwd),document.addEventListener("pwd-deactived",app.deletePwd),document.addEventListener("check-auth",app.checkAuth),document.addEventListener("search-keyword-changed",app.searchByKeyword),document.addEventListener("reset-diary",app.resetDiary),document.addEventListener("import-diary",app.importDiary),document.addEventListener("export-diary",app.exportDiary),document.addEventListener("theme-changed",app.adjustTheme),document.addEventListener("alarm-enabled",app.addNotification),document.addEventListener("alarm-disabled",app.clearNotification)},getEntryPoint:function(){"use strict";if(document.addEventListener("page-changed",app.pageChanged),JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.PWD_ACTIVE)))return document.dispatchEvent(new CustomEvent("show-pwd-check",{detail:{successCallback:()=>{const e=JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.INITIAL_VIEW));e&&e.route?location.hash=e.route:location.hash="calendar"}}})),"auth";const e=JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.INITIAL_VIEW));return e?e.route:"calendar"},scrollToTop:function(){"use strict";"list"===pageUtil.getCurrentPage()&&listUI.scrollToTop()},getMonthDiaryList:function(){"use strict";const e=new TmDiary;e.year=window.stdDateUtil.getYearStr(),e.month=window.stdDateUtil.getMonthStr(),webDBUtil.selectDiary(e.getDataObj()).then(e=>{app.markDiaryList(e),app.markingCurrentDate()}).catch(e=>{throw e})},markDiaryList:function(e){"use strict";const t=pageUtil.getCurrentPage(),n=e.map(e=>e.date);switch(t){case"calendar":calendarUI.markAssigneByDates(n);break;case"list":listUI.markAssigneByDates(n)}},showListView:function(){"use strict";location.hash="list"},showCalendarView:function(){"use strict";location.hash="calendar"},routeBack:function(){"use strict";const e=pageUtil.getCurrentPage();"write"===e?editorUI.saveDiary():"setting"===e?settingUI.routeBack():history.back()},pageChanged:function(e){"use strict";const t=e.detail.previousPage,n=e.detail.currentPage;switch(t){case"auth":headerUI.showHeader(),app.adjustStatusBarColor()}switch(n){case"calendar":headerUI.showCommonHeader(),t&&app.getMonthDiaryList(),calendarUI.renderCalendars(),calendarUI.markByDate();break;case"list":headerUI.showCommonHeader(),app.getMonthDiaryList(),listUI.renderLists();break;case"write":headerUI.showEditorHeader();break;case"setting":headerUI.showRouteBackBtn(),headerUI.clearCenterElement(),headerUI.clearRightElement();break;case"auth":headerUI.hideHeader(),app.adjustStatusBarColor();break;case"search":"write"===t&&(headerUI.showSearchHeader(),app.searchByKeyword({detail:headerUI.searchInput.value}));break;default:const e=window.CONST.MENUS.find(e=>e.page===n);if(e&&e.name){const t=document.createElement("span");t.innerText=e.name?e.name:"",headerUI.appendCenterElement(t),headerUI.showRouteBackBtn()}}setTimeout(()=>{sideBarUI.renderMenus()},250)},menuBtnClick:function(){"use strict";sideBarUI.toggleSideBar()},showEmptyViewer:function(){"use strict";viewerUI.showEmptyViewer()},showContentViewer:function(e){"use strict";const t=new TmDiary;t.fileName=e.detail.fileName,webDBUtil.selectDiary(t.getDataObj()).then(e=>{e&&e.length&&viewerUI.showContentViewer(e[0].content)}).catch(e=>{throw e})},showEmptyEditor:function(e){"use strict";editorUI.showEmptyEditor({fileName:e.detail.fileName})},showContentEditor:function(e){"use strict";const t=new TmDiary;t.fileName=e.detail.fileName,webDBUtil.selectDiary(t.getDataObj()).then(t=>{editorUI.showContentEditor({fileName:e.detail.fileName,diary:t[0]})}).catch(e=>{throw e})},showListPreview:function(e){"use strict";const t=e.detail.dateBlock,n=new TmDiary;n.fileName=e.detail.fileName,webDBUtil.selectDiary(n.getDataObj()).then(e=>{t.showDiaryPreview(e[0])}).catch(e=>{throw e})},saveDiary:function(e){"use strict";const t=new TmDiary;t.fileName=e.detail.fileName,t.content=e.detail.content,webDBUtil.selectDiary({fileName:t.fileName}).then(e=>{e.length?(t.id=e[0].id,webDBUtil.replaceDiary(t)):webDBUtil.insertDiary(t)}).then(()=>{-1===location.hash.indexOf("setting")&&history.back(),document.dispatchEvent(new CustomEvent("diary-saved"))}).catch(e=>{throw e})},deleteDiary:function(e){"use strict";webDBUtil.deleteDiary(e.detail.fileName).then(()=>{app.getMonthDiaryList(),viewerUI.showEmptyViewer(),e.detail.callback&&"function"==typeof e.detail.callback&&e.detail.callback(),document.dispatchEvent(new CustomEvent("diary-deleted"))}).catch(e=>{throw e})},dateSwitched:function(){"use strict";headerUI.showCommonHeader(),app.changeHiddenPickerValue(),app.getMonthDiaryList()},markingCurrentDate:function(){"use strict";if(calendarUI.calendar.getYearMonth()===viewerUI.getYearMonth()){const e=calendarUI.getDateCellByDate(window.currentDateUtil.getDate());e.hasAttribute("selected")||e.marking()}},changeHiddenPickerValue:function(){"use strict";const e=window.stdDateUtil.getDateObj(),t=e.year.toString(),n=1===e.month.toString().length?"0"+e.month.toString():e.month.toString();document.getElementById("hidden-datepicker").value=`${t}-${n}`},hideSplashScreen:function(){"use strict";"splashscreen"in navigator&&navigator.splashscreen.hide()},refreshDiary:function(){"use strict";calendarUI.renderCalendars(),listUI.renderList(),headerUI.showCommonHeader(),app.getMonthDiaryList()},savePwd:function(e){"use strict";webDBUtil.deletePwd().then(()=>webDBUtil.insertPwd(e.detail)).then(()=>{window.ha.openConfirm({title:"암호 설정",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"암호 설정이 완료 되었습니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]})}).catch(()=>{window.ha.openConfirm({title:"암호 설정 실패",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"암호 설정에 실패 했습니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]})})},deletePwd:function(){"use strict";webDBUtil.deletePwd()},checkAuth:function(e){"use strict";webDBUtil.checkAuth(e.detail).then(()=>{document.dispatchEvent(new CustomEvent("auth-checked",{detail:!0}))}).catch(()=>{document.dispatchEvent(new CustomEvent("auth-checked",{detail:!1}))})},activedHandler:function(){"use strict";blocker.hide(),app.showPwdPage&&(app.showPwdPage=!1,document.dispatchEvent(new CustomEvent("show-pwd-check",{detail:{successCallback:()=>{pageUtil.getCurrentPage()?history.back():location.hash=JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.INITIAL_VIEW)).route}}})))},deactivedHandler:function(){"use strict";"auth"!==pageUtil.getCurrentPage()&&blocker.show()},enterBackgroundHandler:function(){"use strict";"auth"!==pageUtil.getCurrentPage()&&(app.showPwdPage=JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.PWD_ACTIVE)))},searchByKeyword:function(){"use strict";let e=headerUI.searchInput.value;if(!e)return;e=(e=(e=e.replace(/\s+/g,"||")).split("||")).filter(e=>e.length>0);let t="\n      SELECT\n        id,\n        fileName,\n        preview,\n        content,\n        CAST(year AS INT) as year,\n        CAST(month AS INT) as month,\n        CAST(date AS INT) as date  \n      FROM \n        tm_diaries\n      WHERE\n    ";e.forEach(e=>{e&&(t+=`\n          content like '%${e}%' OR\n        `)}),t=t.substr(0,t.lastIndexOf(" OR")),t+="\n      ORDER BY year asc, month asc, date asc\n    ",webDBUtil.doTrx(t,[]).then(t=>{t&&t.length>=0&&(location.hash="search",searchUI.renderSearchList(t,e))}).catch(e=>{throw e})},resetDiary:function(){"use strict";window.spinner.show({message:"초기화 진행중..."}),webDBUtil.doTrx("\n      DELETE FROM tm_diaries\n    ",[]).then(()=>{window.spinner.hide(),document.dispatchEvent(new CustomEvent("diary-reseted")),window.ha.openConfirm({title:"완료",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"Time Machine을 다시 실행 합니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT,callback:()=>{location.hash=JSON.parse(localStorage.getItem(window.CONST.LS_KEYS.INITIAL_VIEW)).route}}]})})},importDiary:function(){"use strict";fileTransUtil.readFiles(window.CONST.FILE.PATH,e=>{const t=e.length;0!==t?window.ha.openConfirm({title:"불러오기",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:`${t}개의 일기를 불러 오시겠습니까? 현재 작성된 일기를 덮어 쓸 수 있으니 주의하세요.`,options:[{name:"불러오기",type:CONST.NATIVE_STYLE.BTN.DESTRUCTIVE,callback:()=>{let n=0;const a=function(){if(n++,window.spinner.show({message:`${n}/${t} 불러오기 진행중...`}),e[n]){const t=e[n].name;fileTransUtil.readFile(t,e=>{document.dispatchEvent(new CustomEvent("save-diary",{detail:{fileName:t,content:e}}))})}else document.removeEventListener("diary-saved",a),window.spinner.hide(),window.ha.openConfirm({title:"불러오기 완료",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:`${t}개의 일기를 불러오는데 성공 했습니다.`,options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]})};document.addEventListener("diary-saved",a);const i=e[n].name;fileTransUtil.readFile(i,e=>{document.dispatchEvent(new CustomEvent("save-diary",{detail:{fileName:i,content:e}}))}),window.spinner.show({message:`${n}/${t} 불러오기 진행중...`})}},{name:"취소",type:CONST.NATIVE_STYLE.BTN.CANCEL}]}):window.ha.openConfirm({title:"불러오기",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"기기에 저장된 일기가 없습니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]})})},exportDiary:function(){"use strict";webDBUtil.doTrx("\n      SELECT fileName, content FROM tm_diaries\n    ",[]).then(e=>{const t=e.length;if(0===t)return void window.ha.openConfirm({title:"내보내기",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"아직 작성하신 일기가 없습니다.",options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]});let n=0;const a=function(){n++,window.spinner.show({message:`${n}/${t} 내보내기 진행중...`}),e[n]?fileTransUtil.writeFile(e[n].fileName,e[n].content):(document.removeEventListener("write-file-success",a),document.removeEventListener("write-file-error",i),window.spinner.hide(),window.ha.openConfirm({title:"내보내기 완료",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:`${e.length}개의 일기를 내보내는데 성공 했습니다.`,options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DEFAULT}]}))},i=function(){window.ha.openConfirm({title:"내보내기 실패",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:`'${event.detail.fileName}' 일기 내보내기에 실패 했습니다.`,options:[{name:"확인",type:CONST.NATIVE_STYLE.BTN.DESTRUCTIVE}]})};document.addEventListener("write-file-success",a),document.addEventListener("write-file-error",i),fileTransUtil.writeFile(e[n].fileName,e[n].content),window.spinner.show({message:`${n}/${t} 내보내기 진행중...`})})},addNotification:function(e){"use strict";const t=e.detail.hour,n=e.detail.minute,a=CONST.NOTIFICATION.TITLE.REMIND_TITLE,i=CONST.NOTIFICATION.SUBTITLE.REMIND_SUBTITLE,r=CONST.NOTIFICATION.MESSAGE.REMIND_MESSAGE;localNotificationUtil.addNotification(a,i,r,t,n,e=>{"non-granted"===e&&window.ha.openConfirm({title:"알람 설정 불가",type:CONST.NATIVE_STYLE.ALERT.DEFAULT,message:"설정을 통해 알람을 허용해 주세요.",options:[{name:"취소",type:CONST.NATIVE_STYLE.BTN.CANCEL,callback:()=>{settingUI.alarmActive.checked=!1,settingUI.alarmActiveChanged()}},{name:"설정",type:CONST.NATIVE_STYLE.BTN.DEFAULT,callback:()=>{settingUI.alarmActive.checked=!1,settingUI.alarmActiveChanged(),window.OpenSettingView.open()}}]})},e=>{throw new Error("Failed to add local notification "+e)})},clearNotification:function(){"use strict";localNotificationUtil.clearNotification(null,e=>{throw new Error("Failed to clear local notification "+e)})}};document.addEventListener("src-imported",app.initializeApplication);